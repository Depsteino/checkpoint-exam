name: Bootstrap Terraform Backend

on:
  workflow_dispatch:
    inputs:
      state_bucket:
        description: S3 bucket name for Terraform state
        required: true
        default: candidate-2-terraform-s3
      lock_table:
        description: DynamoDB table name for Terraform locks
        required: true
        default: candidate-2-terraform-lock
      aws_region:
        description: AWS region
        required: true
        default: us-east-1

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Abort if backend already exists
        env:
          STATE_BUCKET: ${{ inputs.state_bucket }}
          LOCK_TABLE: ${{ inputs.lock_table }}
        run: |
          set -euo pipefail
          if aws s3api head-bucket --bucket "${STATE_BUCKET}" 2>/dev/null; then
            echo "State bucket already exists. Bootstrap should only run once."
            exit 1
          fi
          if aws dynamodb describe-table --table-name "${LOCK_TABLE}" >/dev/null 2>&1; then
            echo "Lock table already exists. Bootstrap should only run once."
            exit 1
          fi

      - name: Create/Verify S3 State Bucket
        env:
          STATE_BUCKET: ${{ inputs.state_bucket }}
          AWS_REGION: ${{ inputs.aws_region }}
        run: |
          set -euo pipefail
          if aws s3api head-bucket --bucket "${STATE_BUCKET}" 2>/dev/null; then
            echo "S3 bucket exists: ${STATE_BUCKET}"
          else
            echo "Creating S3 bucket: ${STATE_BUCKET}"
            if [ "${AWS_REGION}" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "${STATE_BUCKET}" --region "${AWS_REGION}"
            else
              aws s3api create-bucket \
                --bucket "${STATE_BUCKET}" \
                --region "${AWS_REGION}" \
                --create-bucket-configuration "LocationConstraint=${AWS_REGION}"
            fi
          fi

          # NOTE: Disabled due to SCP explicit deny in exam AWS account.
          # aws s3api put-public-access-block \
          #   --bucket "${STATE_BUCKET}" \
          #   --public-access-block-configuration \
          #   "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"

          aws s3api put-bucket-versioning \
            --bucket "${STATE_BUCKET}" \
            --versioning-configuration Status=Enabled

          aws s3api put-bucket-encryption \
            --bucket "${STATE_BUCKET}" \
            --server-side-encryption-configuration \
            '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'

          aws s3api head-bucket --bucket "${STATE_BUCKET}"

      - name: Create/Verify DynamoDB Lock Table
        env:
          LOCK_TABLE: ${{ inputs.lock_table }}
        run: |
          set -euo pipefail
          if aws dynamodb describe-table --table-name "${LOCK_TABLE}" >/dev/null 2>&1; then
            echo "DynamoDB table exists: ${LOCK_TABLE}"
          else
            echo "Creating DynamoDB table: ${LOCK_TABLE}"
            aws dynamodb create-table \
              --table-name "${LOCK_TABLE}" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST
          fi

          aws dynamodb wait table-exists --table-name "${LOCK_TABLE}"

      - name: Show Backend Resources
        env:
          STATE_BUCKET: ${{ inputs.state_bucket }}
          LOCK_TABLE: ${{ inputs.lock_table }}
        run: |
          set -euo pipefail
          echo "State bucket: ${STATE_BUCKET}"
          aws s3api get-bucket-location --bucket "${STATE_BUCKET}"
          echo "Lock table ARN:"
          aws dynamodb describe-table --table-name "${LOCK_TABLE}" --query 'Table.TableArn' --output text
