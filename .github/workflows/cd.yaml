name: CD

on:
  workflow_run:
    workflows: [CI]
    types: [completed]

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      PROJECT_NAME: candidate-2
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Precheck Infra (ECS)
        env:
          AWS_REGION: us-east-1
          PROJECT_NAME: candidate-2
        run: |
          set -euo pipefail
          CLUSTER_NAME="${PROJECT_NAME}-cluster"
          aws ecs describe-clusters --clusters "${CLUSTER_NAME}" --query 'clusters[0].status' --output text | grep -q ACTIVE
          aws ecs describe-services --cluster "${CLUSTER_NAME}" \
            --services microservice-1-producer microservice-2-consumer \
            --query 'services[].status' --output text | grep -q ACTIVE

      - name: Deploy to ECS
        env:
          IMAGE_TAG: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_REGISTRY="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          CLUSTER_NAME="${PROJECT_NAME}-cluster"

          deploy_service() {
            local service_name="$1"
            local task_family="$2"
            local image="${ECR_REGISTRY}/${task_family}:${IMAGE_TAG}"

            task_def_json=$(aws ecs describe-task-definition --task-definition "${task_family}" --query 'taskDefinition')
            new_task_def_json=$(echo "${task_def_json}" | jq \
              --arg IMAGE "${image}" \
              '.containerDefinitions[0].image=$IMAGE
              | del(.taskDefinitionArn,.revision,.status,.requiresAttributes,.compatibilities,.registeredAt,.registeredBy)')

            new_task_def_arn=$(aws ecs register-task-definition \
              --cli-input-json "${new_task_def_json}" \
              --query 'taskDefinition.taskDefinitionArn' \
              --output text)

            aws ecs update-service \
              --cluster "${CLUSTER_NAME}" \
              --service "${service_name}" \
              --task-definition "${new_task_def_arn}"
          }

          deploy_service "microservice-1-producer" "microservice-1-producer"
          deploy_service "microservice-2-consumer" "microservice-2-consumer"
